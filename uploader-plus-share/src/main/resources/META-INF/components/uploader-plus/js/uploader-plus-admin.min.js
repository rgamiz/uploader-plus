'use strict';Alfresco.logger.debug("uploader-plus-admin.js");SoftwareLoop.UploaderPlusAdmin=function(b){Alfresco.logger.debug("UploaderPlusAdmin constructor");SoftwareLoop.UploaderPlusAdmin.superclass.constructor.call(this,"SoftwareLoop.UploaderPlusAdmin",b,"button container datasource datatable paginator history animation".split(" "));return this};
YAHOO.extend(SoftwareLoop.UploaderPlusAdmin,Alfresco.component.Base,{uploadFoldersListUrl:Alfresco.constants.PROXY_URI+"uploader-plus/upload-folders-list",listContentTypesUrl:Alfresco.constants.PROXY_URI+"uploader-plus/list-content-types",onReady:function(){Alfresco.logger.debug("onReady",arguments);this.setupDataTable();this.setupNewUploadFolderButton();Alfresco.logger.debug("END onReady")},prettyPath:function(b){Alfresco.logger.debug("prettyPath",arguments);var a=b.substring(b.indexOf("/",1));""===
a&&(Alfresco.logger.debug("Adjusting root path"),a="/");Alfresco.logger.debug("END prettyPath",a);return a},pathFormatter:function(b,a,d,e){Alfresco.logger.debug("pathFormatter",arguments);var c=this.prettyPath(e),f=YAHOO.lang.substitute("{pageContext}repository#filter={path}&page=1",{pageContext:Alfresco.constants.URL_PAGECONTEXT,path:encodeURIComponent("path|"+c+"|")});b.innerHTML=YAHOO.lang.substitute("<a href='{href}' title='{title}'>{text}</a>",{href:Alfresco.util.encodeHTML(f),title:this.msg("open.in.repository"),
text:Alfresco.util.encodeHTML(c)});Alfresco.logger.debug("END pathFormatter")},allowedTypesFormatter:function(b,a,d,e){Alfresco.logger.debug("allowedTypesFormatter",arguments);for(var c="",f=0;f<e.length;f++){Alfresco.logger.debug("Adding allowed type",e[f]);0<f&&(c+=", ");var g=this.msg("type."+e[f].replace(":","_"));c=0===g.lastIndexOf("type.",0)?c+Alfresco.util.encodeHTML(e[f]):c+Alfresco.util.encodeHTML(g)}b.innerHTML=c;Alfresco.logger.debug("END allowedTypesFormatter")},actionFormatter:function(b,
a,d,e){Alfresco.logger.debug("actionFormatter",arguments);a.getData();b.innerHTML="<div class='action'><a class='edit-upload-folder'>"+this.msg("button.edit")+"</a> | <a class='delete-upload-folder'>"+this.msg("button.delete")+"</a></div>";Alfresco.logger.debug("END actionFormatter")},setupDataTable:function(){Alfresco.logger.debug("setupDataTable",arguments);var b=[{key:"path",label:this.msg("title.path"),sortable:!1,formatter:SoftwareLoop.hitch(this,this.pathFormatter)},{key:"allowedTypes",label:this.msg("title.allowed.types"),
sortable:!1,formatter:SoftwareLoop.hitch(this,this.allowedTypesFormatter)},{key:"actions",label:this.msg("title.actions"),sortable:!1,formatter:SoftwareLoop.hitch(this,this.actionFormatter)}],a=this.widgets.dataSource=new YAHOO.util.DataSource(this.uploadFoldersListUrl,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"results",fields:["path","nodeRef","allowedTypes"]}});b=this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-folders",b,a,
{initialLoad:{},MSG_LOADING:this.msg("loading.folders"),MSG_EMPTY:this.msg("no.folders.found")});b.subscribe("rowMouseoverEvent",b.onEventHighlightRow);b.subscribe("rowMouseoutEvent",b.onEventUnhighlightRow);YAHOO.util.Event.delegate(this.id,"click",SoftwareLoop.hitch(this,this.editUploadFolderHandler),"a.edit-upload-folder");YAHOO.util.Event.delegate(this.id,"click",SoftwareLoop.hitch(this,this.deleteUploadFolderHandler),"a.delete-upload-folder");Alfresco.logger.debug("END setupDataTable")},setupNewUploadFolderButton:function(){Alfresco.logger.debug("setupNewUploadFolderButton",
arguments);this.widgets.newUploadFolderButton=new YAHOO.widget.Button(this.id+"-new-upload-folder");this.widgets.newUploadFolderButton.on("click",function(){this.promptForFolder()},null,this);Alfresco.logger.debug("END setupNewUploadFolderButton")},promptForFolder:function(){Alfresco.logger.debug("promptForFolder",arguments);var b=new Alfresco.module.DoclibGlobalFolder(this.id+"-new-form"),a=Alfresco.module.DoclibGlobalFolder;b.setOptions({viewMode:a.VIEW_MODE_SITE,defaultViewMode:a.VIEW_MODE_SITE,
allowedViewModes:[a.VIEW_MODE_SITE,a.VIEW_MODE_REPOSITORY,a.VIEW_MODE_SHARED,a.VIEW_MODE_USERHOME],title:this.msg("select.the.upload.folder")});var d=this;b.onOK=function(){Alfresco.logger.debug("onOK callback");Alfresco.module.DoclibGlobalFolder.prototype.onOK.apply(this,arguments);this.selectedNode&&(Alfresco.logger.debug("A node was selected",this.selectedNode),d.createUploadFolder(this.selectedNode.data.nodeRef))};b.showDialog();Alfresco.logger.debug("END promptForFolder")},createUploadFolder:function(b){Alfresco.logger.debug("createUploadFolder",
arguments);var a=Alfresco.util.NodeRef(b);a=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"uploader-plus/upload-folders-new/{storeType}/{storeId}/{id}",a);Alfresco.util.Ajax.jsonPost({url:a,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(d){Alfresco.logger.debug("successCallback",arguments);var e=d.json.status,c=d.json.node;0==e?(Alfresco.logger.debug("status == 0"),e=this.findUploadFolderPosition(c),this.widgets.dataTable.addRow(c,e),c=this.widgets.dataTable.getRecord(e),
this.editUploadFolderRecord(c)):1==e&&(Alfresco.logger.debug("status == 1"),Alfresco.util.PopupManager.displayMessage({text:YAHOO.lang.substitute(this.msg("_.is.already.an.upload.folder"),c)}))},scope:this},failureMessage:this.msg("operation.failed")});Alfresco.logger.debug("END createUploadFolder")},findUploadFolderPosition:function(b){Alfresco.logger.debug("findUploadFolderPosition",arguments);for(var a=this.widgets.dataTable.getRecordSet().getRecords(),d=0;d<a.length;d++)if(Alfresco.logger.debug("Scanning upload folder",
d),a[d].getData().path>b.path)return Alfresco.logger.debug("Found position"),d;Alfresco.logger.debug("END findUploadFolderPosition",d);return d},editUploadFolderHandler:function(b,a,d){Alfresco.logger.debug("editUploadFolderHandler",arguments);var e=this.widgets.dataTable.getRecord(a.parentNode.parentNode.parentNode);this.editUploadFolderRecord(e);Alfresco.logger.debug("END editUploadFolderHandler")},editUploadFolderRecord:function(b){Alfresco.logger.debug("editUploadFolderRecord",arguments);var a=
b.getData(),d=this.id+"-edit-form",e=YAHOO.lang.substitute("{serviceContext}components/form?itemKind=node&itemId={itemId}&mode=edit&submitType=json&formId={formId}&showCancelButton=true&htmlid={htmlid}",{serviceContext:Alfresco.constants.URL_SERVICECONTEXT,itemId:a.nodeRef,formId:"upload-folder",htmlid:d}),c=Alfresco.util.NodeRef(a.nodeRef);c=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/node/{storeType}/{storeId}/{id}/formprocessor",c);(new Alfresco.module.SimpleDialog(d)).setOptions({width:"40em",
templateUrl:e,actionUrl:c,destroyOnHide:!0,doBeforeDialogShow:{fn:function(){Alfresco.logger.debug("doBeforeDialogShow callback",arguments);var f=YAHOO.util.Dom.get(d+"-dialogTitle");f&&(f.innerHTML=Alfresco.util.encodeHTML(this.prettyPath(a.path)));f=YAHOO.util.Dom.getElementsByClassName("supported-types-select","select")[0];this.populateAllowedTypesSelect(f);return!0},scope:this},onSuccess:{fn:function(f){Alfresco.logger.debug("onSuccess callback",arguments);a.allowedTypes=f.config.dataObj.prop_up_allowedTypes.split(",");
this.widgets.dataTable.updateRow(b,a);Alfresco.util.PopupManager.displayMessage({text:this.msg("operation.completed.successfully")})},scope:this},onFailure:{fn:function(f){Alfresco.logger.debug("onFailure callback",arguments);Alfresco.util.PopupManager.displayMessage({text:this.msg("operation.failed")})},scope:this}}).show();Alfresco.logger.debug("END editUploadFolderRecord")},deleteUploadFolderHandler:function(b,a,d){Alfresco.logger.debug("deleteUploadFolderHandler",arguments);var e=this.widgets.dataTable.getRecord(a.parentNode.parentNode.parentNode),
c=e.getData();c=Alfresco.util.NodeRef(c.nodeRef);Alfresco.util.Ajax.jsonPost({url:YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"slingshot/doclib/action/aspects/node/{storeType}/{storeId}/{id}",c),dataObj:{added:[],removed:["up:UploadFolder"]},requestContentType:Alfresco.util.Ajax.JSON,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(f){Alfresco.logger.debug("deleteUploadFolderHandler successCallback",arguments);Alfresco.util.PopupManager.displayMessage({text:this.msg(f.json.overallSuccess?
"operation.completed.successfully":"operation.failed")});this.widgets.dataTable.deleteRow(e)},scope:this},failureMessage:this.msg("operation.failed")});Alfresco.logger.debug("END deleteUploadFolderHandler")},populateAllowedTypesSelect:function(b){Alfresco.logger.debug("populateAllowedTypesSelect",arguments);var a=b.getAttribute("data-selectedValues"),d=[];a&&(d=a.split(","));Alfresco.util.Ajax.jsonGet({url:this.listContentTypesUrl,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(e){Alfresco.logger.debug("populateAllowedTypesSelect successCallback",
arguments);for(var c=e.json.types,f=0;f<c.length;f++){Alfresco.logger.debug("Type index",f);var g=c[f],k=-1<d.indexOf(g),h=this.msg("type."+g.replace(":","_"));0===h.lastIndexOf("type.",0)&&(h=g);g=new Option(h,g);b.add(g);g.selected=k}},scope:this},failureCallback:{fn:function(e){Alfresco.logger.debug("populateAllowedTypesSelect failureCallback",arguments)},scope:this}});Alfresco.logger.debug("END populateAllowedTypesSelect")}});
